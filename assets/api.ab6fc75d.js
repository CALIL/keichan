var t=Object.defineProperty,e=(e,i,s)=>(((e,i,s)=>{i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[i]=s})(e,"symbol"!=typeof i?i+"":i,s),s);import{u as i,l as s,b as r}from"./vendor.8948ae52.js";function a(t){t=i.nfkc(t).toUpperCase().replace(/[^0-9X]/g,"");let e=s.parse(t);if(e){if(e.isIsbn10())return e.asIsbn10();if(e.isIsbn13()){return e.asIsbn13().startsWith("978")?e.asIsbn10():e.asIsbn13()}}else{let e=s.parse("978"+t);if(e&&e.isIsbn13())return e.asIsbn10()}return!1}const o=["free","title","author","publisher","isbn","ndc","year_start","year_end","region"];function n(t){return r.get("https://unitrad.calil.jp/v1/"+t)}class l{constructor(t,i){e(this,"callback"),e(this,"killed"),e(this,"data"),this.callback=i,this.killed=!1,this.search(t)}kill(){this.killed=!0}search(t){this.killed||n("search").query(function(t){let e={};for(let i of o)t.hasOwnProperty(i)&&""!==t[i]&&(e[i]=t[i]);return e}(t)).end(((e,i)=>{e?setTimeout((()=>this.search(t)),1e3):this.receive(i.body)}))}polling(){this.killed||n("polling").query({uuid:this.data.uuid,version:this.data.version,diff:1,timeout:10}).end(((t,e)=>{null===e.body?setTimeout((()=>this.polling()),100):this.receive(e.body)}))}receive(t){if(!this.killed){if(t.books_diff){Array.prototype.push.apply(this.data.books,t.books_diff.insert);for(let e in t)t.hasOwnProperty(e)&&"books_diff"!==e&&(this.data[e]=t[e]);for(let e of t.books_diff.update)for(let t in e)if(e.hasOwnProperty(t)&&"_idx"!==t)if(!0===Array.isArray(e[t]))Array.prototype.push.apply(this.data.books[e._idx][t],e[t]);else if(e[t]instanceof Object)for(let i in e[t])e[t].hasOwnProperty(i)&&(this.data.books[e._idx][t][i]=e[t][i]);else this.data.books[e._idx][t]=e[t]}else this.data=t;this.callback(this.data),!0===t.running?(console.log("[Unitrad] continue..."),1===t.version&&0===this.data.books.length?setTimeout((()=>this.polling()),20):setTimeout((()=>this.polling()),500)):console.log("[Unitrad] complete.")}}}export{l as a,a as n};
