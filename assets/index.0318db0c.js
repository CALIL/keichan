var e=Object.defineProperty,t=(t,s,i)=>(((t,s,i)=>{s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i})(t,"symbol"!=typeof s?s+"":s,i),i);import{u as s,l as i,r as o,a,R as n,S as r,b as l}from"./vendor.212ae81a.js";!function(e=".",t="__import__"){try{self[t]=new Function("u","return import(u)")}catch(s){const i=new URL(e,location),o=e=>{URL.revokeObjectURL(e.src),e.remove()};self[t]=e=>new Promise(((s,a)=>{const n=new URL(e,i);if(self[t].moduleMap[n])return s(self[t].moduleMap[n]);const r=new Blob([`import * as m from '${n}';`,`${t}.moduleMap['${n}']=m;`],{type:"text/javascript"}),l=Object.assign(document.createElement("script"),{type:"module",src:URL.createObjectURL(r),onerror(){a(new Error(`Failed to import: ${e}`)),o(l)},onload(){s(self[t].moduleMap[n]),o(l)}});document.head.appendChild(l)})),self[t].moduleMap={}}}("/keichan/assets/");const h=["free","title","author","publisher","isbn","ndc","year_start","year_end","region"];function u(e){return o.get("https://unitrad.calil.jp/v1/"+e)}class d{constructor(e,s){t(this,"callback"),t(this,"killed"),t(this,"data"),this.callback=s,this.killed=!1,this.search(e)}kill(){this.killed=!0}search(e){this.killed||u("search").query(function(e){let t={};for(let s of h)e.hasOwnProperty(s)&&""!==e[s]&&(t[s]=e[s]);return t}(e)).end(((t,s)=>{t?setTimeout((()=>this.search(e)),1e3):this.receive(s.body)}))}polling(){this.killed||u("polling").query({uuid:this.data.uuid,version:this.data.version,diff:1,timeout:10}).end(((e,t)=>{null===t.body?setTimeout((()=>this.polling()),100):this.receive(t.body)}))}receive(e){if(!this.killed){if(e.books_diff){Array.prototype.push.apply(this.data.books,e.books_diff.insert);for(let t in e)e.hasOwnProperty(t)&&"books_diff"!==t&&(this.data[t]=e[t]);for(let t of e.books_diff.update)for(let e in t)if(t.hasOwnProperty(e)&&"_idx"!==e)if(!0===Array.isArray(t[e]))Array.prototype.push.apply(this.data.books[t._idx][e],t[e]);else if(t[e]instanceof Object)for(let s in t[e])t[e].hasOwnProperty(s)&&(this.data.books[t._idx][e][s]=t[e][s]);else this.data.books[t._idx][e]=t[e]}else this.data=e;this.callback(this.data),!0===e.running?(console.log("[Unitrad] continue..."),1===e.version&&0===this.data.books.length?setTimeout((()=>this.polling()),20):setTimeout((()=>this.polling()),500)):console.log("[Unitrad] complete.")}}}class c extends a.exports.Component{constructor(e){super(e),this.state={invalidISBN:!1,books:[]},this.timer=null,this.str="",this.prevISBN=null,this.documentCode=null}onKeyDown(e){if("Spreadsheet__data-editor"===e.target.parentNode.className)return;const t=e||window.event,s=t.keyCode||t.which||t.charCode;console.log(this.str),console.log(e.key),"Enter"===e.key||13===s?(this.checkStr(),this.timer&&clearTimeout(this.timer),this.str=""):(1===e.key.length?this.str+=e.key:"Shift"===e.key||(this.str=""),this.timer&&clearTimeout(this.timer),this.timer=setTimeout((()=>{console.log("clear"),this.checkStr(),this.str=""}),300))}checkStr(){!function(e){e=s.nfkc(e).toUpperCase().replace(/[^0-9X]/g,"");let t=i.parse(e);if(t){if(t.isIsbn10())return t.asIsbn10();if(t.isIsbn13())return t.asIsbn13().startsWith("978")?t.asIsbn10():t.asIsbn13()}else{let t=i.parse("978"+e);if(t&&t.isIsbn13())return t.asIsbn10()}return!1}(this.str)?(this.setState({invalidISBN:!0}),this.str.match(/^[A-D][0-9]+[A-D]$/)?this.pushTempBook(this.str.replace(/[A-D]/g,"")):this.pushTempBook(this.str)):(this.setState({invalidISBN:!1}),this.addBook(this.str))}componentDidMount(){window.document.addEventListener("keydown",this.onKeyDown.bind(this))}addBook(e){this.api=new d({isbn:e,region:"recipe"},(e=>{if(e.count>=1){const t=e.books[0];this.pushBook(t)}else console.log("not found");this.api=null}))}pushBook(e){const{isbn:t,title:s,author:i,publisher:o,pubdate:a}=e;this.prevISBN!==t&&(this.documentCode?(this.state.books.shift(),this.state.books.unshift([{value:this.documentCode},{value:t},{value:s},{value:i},{value:o},{value:a}]),this.documentCode=null):this.state.books.unshift([{value:t},{value:t},{value:s},{value:i},{value:o},{value:a}]),this.setState({}),this.prevISBN=t)}pushTempBook(e){e.startsWith("192")||this.documentCode!==e&&(this.state.books.unshift([{value:e},{value:""},{value:""},{value:""},{value:""},{value:""}]),this.setState({}),this.documentCode=e)}render(){return 0===this.state.books.length?n.createElement("div",{className:"description"},n.createElement("div",null,n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"},n.createElement("path",{d:"M0 448V64h18v384H0zm26.857-.273V64H36v383.727h-9.143zm27.143 0V64h8.857v383.727H54zm44.857 0V64h8.857v383.727h-8.857zm36 0V64h17.714v383.727h-17.714zm44.857 0V64h8.857v383.727h-8.857zm18 0V64h8.857v383.727h-8.857zm18 0V64h8.857v383.727h-8.857zm35.715 0V64h18v383.727h-18zm44.857 0V64h18v383.727h-18zm35.999 0V64h18.001v383.727h-18.001zm36.001 0V64h18.001v383.727h-18.001zm26.857 0V64h18v383.727h-18zm45.143 0V64h26.857v383.727h-26.857zm35.714 0V64h9.143v383.727H476zm18 .273V64h18v384h-18z"})),"バーコードをスキャンしてください")):n.createElement(r,{data:this.state.books,columnLabels:["id","isbn","タイトル","著者","出版社","出版年"]})}}l.render(n.createElement(c,null),document.getElementById("app"));
