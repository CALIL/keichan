import{u as t,l as e,r as s,R as n,I as o,X as i,F as r,S as a,a as l}from"./vendor.961c6a32.js";!function(t=".",e="__import__"){try{self[e]=new Function("u","return import(u)")}catch(s){const n=new URL(t,location),o=t=>{URL.revokeObjectURL(t.src),t.remove()};self[e]=t=>new Promise(((s,i)=>{const r=new URL(t,n);if(self[e].moduleMap[r])return s(self[e].moduleMap[r]);const a=new Blob([`import * as m from '${r}';`,`${e}.moduleMap['${r}']=m;`],{type:"text/javascript"}),l=Object.assign(document.createElement("script"),{type:"module",src:URL.createObjectURL(a),onerror(){i(new Error(`Failed to import: ${t}`)),o(l)},onload(){s(self[e].moduleMap[r]),o(l)}});document.head.appendChild(l)})),self[e].moduleMap={}}}("/keichan/assets/");function h(s){s=t.nfkc(s).toUpperCase().replace(/[^0-9X]/g,"");let n=e.parse(s);if(n){if(n.isIsbn10())return n.asIsbn10();if(n.isIsbn13()){return n.asIsbn13().startsWith("978")?n.asIsbn10():n.asIsbn13()}}else{let t=e.parse("978"+s);if(t&&t.isIsbn13())return t.asIsbn10()}return!1}class u extends s.exports.Component{constructor(){super(),this.state={}}render(){return n.createElement("div",{className:"book",onClick:()=>this.props.open(this.props.book)},this.props.book.isbn&&(this.props.count<10*this.props.updateCount||this.props.completed)?n.createElement("img",{src:`https://calil.jp/cover/${this.props.book.isbn}`}):null,n.createElement("div",null,n.createElement("div",{className:"title"},this.props.book.title),n.createElement("div",{className:"author"},this.props.book.author)))}}exports.__esModule=!0,exports.fetchMapping=exports.stripQuery=exports.isEqualQuery=exports.isEmptyQuery=exports.normalizeQuery=exports.api=void 0;var c=require("query-string"),p=["free","title","author","publisher","isbn","ndc","year_start","year_end","region"];function d(t,e){return fetch("https://unitrad.calil.jp/v1/"+t+"?"+c.default.stringify(e)).then((function(t){return t.json()}))}var m=function(){function t(t,e){this.callback=e,this.killed=!1,this.search(t)}return t.prototype.kill=function(){this.killed=!0},t.prototype.search=function(t){var e=this;this.killed||d("search",v(t)).then((function(t){e.receive(t)})).catch((function(){setTimeout((function(){return e.search(t)}),1e3)}))},t.prototype.polling=function(){var t=this;this.killed||d("polling",{uuid:this.data.uuid,version:this.data.version,diff:1,timeout:10}).then((function(e){t.receive(e)})).catch((function(){setTimeout((function(){return t.polling()}),100)}))},t.prototype.receive=function(t){var e=this;if(!this.killed){if(t.books_diff){for(var s in Array.prototype.push.apply(this.data.books,t.books_diff.insert),t)t.hasOwnProperty(s)&&"books_diff"!==s&&(this.data[s]=t[s]);for(var n=0,o=t.books_diff.update;n<o.length;n++){var i=o[n];for(var s in i)if(i.hasOwnProperty(s)&&"_idx"!==s)if(!0===Array.isArray(i[s]))Array.prototype.push.apply(this.data.books[i._idx][s],i[s]);else if(i[s]instanceof Object)for(var r in i[s])i[s].hasOwnProperty(r)&&(this.data.books[i._idx][s][r]=i[s][r]);else this.data.books[i._idx][s]=i[s]}}else this.data=t;this.callback(this.data),t.remains.includes("openBD")||t.remains.includes("国立国会図書館")?(console.log("[Unitrad] continue..."),setTimeout((function(){return e.polling()}),500)):console.log("[Unitrad] complete.")}},t}();function v(t){for(var e={},s=0,n=p;s<n.length;s++){var o=n[s];console.log(t[o]),t.hasOwnProperty(o)&&t[o]&&""!==t[o]&&(e[o]=t[o])}return e}exports.normalizeQuery=function(t){for(var e={},s=0,n=p;s<n.length;s++){var o=n[s];e[o]=t[o]?t[o]:""}return e},exports.isEmptyQuery=function(t){if(t)for(var e=0,s=p;e<s.length;e++){var n=s[e];if("region"!==n&&(t.hasOwnProperty(n)&&""!==t[n]))return!1}return!0},exports.isEqualQuery=function(t,e){for(var s=0,n=p;s<n.length;s++){var o=n[s];if("region"!==o&&(t&&t.hasOwnProperty(o)?t[o]:"")!==(e&&e.hasOwnProperty(o)?e[o]:""))return!1}return!0},exports.stripQuery=v,exports.fetchMapping=function(t,e){d("mapping",{region:t}).then((function(t){e(t)}))};class g extends s.exports.Component{constructor(t){super(t),this.api=null,this.prevQuery="",this.state={loading:!1,running:!1,books:[],message:"",hint:"",updateCount:0}}kill(){this.api&&(this.api.kill(),this.setState({updateCount:0,running:!1}))}componentDidMount(){this.props.query===this.prevQuery&&(this.state.showResult=!0),""!=this.props.query&&this.props.query!=this.prevQuery&&(this.kill(),this.prevQuery=this.props.query,this.api=new m({free:this.props.query,region:this.props.region},(t=>{let e=[];t.books.slice(0,300).map((t=>{if(t.isbn&&t.isbn.length>=10){const s=o.parse(t.isbn);t.isbn=s?s.asIsbn13():t.isbn.replace(/-/g,""),e.push(t)}else t.isbn=void 0,e.push(t)}));let s=t.running;e.length>20&&(s=!1,this.kill()),this.setState({books:e,loading:s&&e.length<10,running:s,notFound:!1===s&&0===e.length,updateCount:this.state.updateCount+1,showResult:!0})})))}componentDidUpdate(){this.componentDidMount()}componentWillUnmount(){this.kill()}render(){let t=0;return n.createElement("div",{className:"suggest"},this.state.books.length>0?n.createElement("div",{className:"results"},this.state.books.map((e=>(t+=1,n.createElement(u,{book:e,key:e.id,count:t,updateCount:this.state.updateCount,completed:!this.state.running,open:t=>{this.props.open(t)}}))))):this.state.running?n.createElement("div",{className:"message"},"検索中..."):null,this.state.notFound?n.createElement("div",{className:"message"},"見つかりませんでした"):null)}}class f extends s.exports.Component{constructor(t){super(t),this.state={isRecognition:!1}}start(){const t=new webkitSpeechRecognition;t.lang="ja-JP",this.setState({isRecognition:!0}),t.onend=()=>{console.log("on end"),t.stop(),this.setState({isRecognition:!1})},t.onresult=t=>{t.results.length>0&&this.props.onEnd(t.results[0][0].transcript)},t.onstart=()=>{console.log("on start")},t.onspeechstart=()=>{console.log("on speech start")},t.onspeechend=()=>{console.log("on speech end")},t.onsoundend=()=>{console.log("on sound end")},t.onaudiostart=()=>{console.log("on audio start")},t.onaudioend=()=>{console.log("on audio end")},t.start()}render(){return"webkitSpeechRecognition"in window?n.createElement("span",{className:"speech",onClick:this.start.bind(this)},this.state.isRecognition?"認識中…":n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 352 512"},n.createElement("path",{d:"M176 352c53.02 0 96-42.98 96-96V96c0-53.02-42.98-96-96-96S80 42.98 80 96v160c0 53.02 42.98 96 96 96zm160-160h-16c-8.84 0-16 7.16-16 16v48c0 74.8-64.49 134.82-140.79 127.38C96.71 376.89 48 317.11 48 250.3V208c0-8.84-7.16-16-16-16H16c-8.84 0-16 7.16-16 16v40.16c0 89.64 63.97 169.55 152 181.69V464H96c-8.84 0-16 7.16-16 16v16c0 8.84 7.16 16 16 16h160c8.84 0 16-7.16 16-16v-16c0-8.84-7.16-16-16-16h-56v-33.77C285.71 418.47 352 344.9 352 256v-48c0-8.84-7.16-16-16-16z"}))):null}}class b extends s.exports.Component{constructor(t){super(t),this.state={books:[],invalidISBN:!1,scanner:!1,notFound:!1,query:"",showSuggest:!1},this.textInput=null,this.setTextInputRef=t=>{this.textInput=t},this.setTextInput=t=>{this.textInput&&(this.textInput.value=t)},this.timer=null,this.str="",this.prevISBN=null}load(){const t=localStorage.getItem("spreadsheet");if(t){const e=JSON.parse(t);this.setState({books:e})}}save(){localStorage.setItem("spreadsheet",JSON.stringify(this.state.books))}speak(t){if("speechSynthesis"in window){const e=new SpeechSynthesisUtterance(t);e.rate=1.5,speechSynthesis.speak(e)}}speech(t){var e;t&&(this.setTextInput(t),null==(e=this.textInput)||e.focus(),this.setState({query:t,invalidISBN:!1,showSuggest:!0}))}pushBook(t,e){var s;this.prevISBN!==e&&(this.state.books.unshift([{value:t},{value:e},{value:""},{value:""}]),this.setState({notFound:!1}),this.save(),this.speak(t),e&&(this.prevISBN=e),null==(s=this.textInput)||s.focus())}addBook(t){new m({isbn:t,region:"recipe"},(t=>{if(t.count>=1){const e=t.books[0];this.pushBook(e.title,e.isbn)}else console.log("not found"),this.setState({notFound:!0})}))}selectBook(t){this.setState({showSuggest:!1}),this.pushBook(t.title,t.isbn)}submit(t){var e;t.preventDefault();const s=null==(e=this.textInput)?void 0:e.value;s&&s.length>=10?h(s)?(this.setState({invalidISBN:!1,showSuggest:!1}),this.setTextInput(s),this.addBook(s)):this.setState({invalidISBN:!0,showSuggest:!1}):this.setState({query:s,invalidISBN:!1,showSuggest:!0})}delete(t){var e;const s=this.state.books.filter(((e,s)=>s!==t));this.setState({books:s},this.save),null==(e=this.textInput)||e.focus()}onKeyDown(t){if("Spreadsheet__data-editor"===t.target.parentNode.className)return;const e=t||window.event,s=e.keyCode||e.which||e.charCode;"Enter"===t.key||13===s?(this.str.length>=10&&(h(this.str)?(this.setState({invalidISBN:!1,scanner:!0}),this.setTextInput(this.str),this.addBook(this.str),console.log("scanned:",this.str)):this.setState({invalidISBN:!0})),this.timer&&clearTimeout(this.timer),this.str=""):(1===t.key.length?this.str+=t.key:this.str="",this.timer&&clearTimeout(this.timer),this.timer=setTimeout((()=>{console.log("clear"),this.str.length>=10&&(h(this.str)?(this.setState({invalidISBN:!1}),this.setTextInput(this.str),this.addBook(this.str)):this.setState({invalidISBN:!0})),this.str=""}),300))}componentDidMount(){var t;this.load(),null==(t=this.textInput)||t.focus(),window.document.addEventListener("keydown",this.onKeyDown.bind(this)),document.body.addEventListener("click",(t=>{t.target.closest(".inputForm")||this.setState({showSuggest:!1})}))}onCellCommit(t,e,s){var n,o,i;const r=null==(i=null==(o=null==(n=this.spreadsheet_ref)?void 0:n.prevState)?void 0:o.lastChanged)?void 0:i.row;s&&(this.state.books.map(((n,o)=>{o===r&&n[s.column].value===t.value&&(n[s.column].value=e.value)})),this.setState({}),this.save())}downloadXSLX(){const t=i.utils.book_new();t.Props={Title:"",Subject:"",Author:"",CreatedDate:new Date},t.SheetNames.push("Test Sheet");const e=[];this.state.books.map((t=>{e.push([t[0].value,t[1].value,t[2].value,t[3].value])}));const s=i.utils.aoa_to_sheet(e);t.Sheets["Test Sheet"]=s;const n=i.write(t,{bookType:"xlsx",type:"binary"});r.exports.saveAs(new Blob([function(t){const e=new ArrayBuffer(t.length),s=new Uint8Array(e);for(let n=0;n<t.length;n++)s[n]=255&t.charCodeAt(n);return e}(n)],{type:"application/octet-stream"}),"test.xlsx")}render(){return n.createElement(n.Fragment,null,n.createElement("div",{className:this.state.showSuggest?"show_suggest":"hide_suggest"},n.createElement(g,{region:"recipe",open:this.selectBook.bind(this),query:this.state.query})),n.createElement("header",null,n.createElement("form",{className:"inputForm",onSubmit:this.submit.bind(this)},n.createElement("input",{type:"text",placeholder:"キーワード or ISBN...",ref:this.setTextInputRef,inputMode:"url",autoFocus:!0}),n.createElement("button",{onClick:this.submit.bind(this)},"検索"),n.createElement(f,{onEnd:this.speech.bind(this)})),(()=>{if(this.state.books.length>0)return n.createElement("div",{className:"right"},n.createElement("div",{className:"count"},this.state.books.length,"冊"),n.createElement("button",{onClick:this.downloadXSLX.bind(this)},"Excelをダウンロード"))})()),(()=>{if(this.state.invalidISBN)return n.createElement("div",{className:"warning"},n.createElement("h3",null,"ISBNが正しくありません"))})(),(()=>{if(this.state.notFound)return n.createElement("div",{className:"warning"},n.createElement("h3",null,"該当する本が見つかりませんでした"))})(),(()=>{if(this.state.scanner)return n.createElement("div",{className:"connected"},n.createElement("h3",null,"バーコードリーダーが接続されました"))})(),(()=>0===this.state.books.length?n.createElement("div",{className:"description",onClick:()=>{var t;return null==(t=this.textInput)?void 0:t.focus()}},n.createElement("div",null,n.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"},n.createElement("path",{d:"M0 448V64h18v384H0zm26.857-.273V64H36v383.727h-9.143zm27.143 0V64h8.857v383.727H54zm44.857 0V64h8.857v383.727h-8.857zm36 0V64h17.714v383.727h-17.714zm44.857 0V64h8.857v383.727h-8.857zm18 0V64h8.857v383.727h-8.857zm18 0V64h8.857v383.727h-8.857zm35.715 0V64h18v383.727h-18zm44.857 0V64h18v383.727h-18zm35.999 0V64h18.001v383.727h-18.001zm36.001 0V64h18.001v383.727h-18.001zm26.857 0V64h18v383.727h-18zm45.143 0V64h26.857v383.727h-26.857zm35.714 0V64h9.143v383.727H476zm18 .273V64h18v384h-18z"})),"ISBNを入力するか、バーコードをスキャンしてください")):n.createElement(a,{data:this.state.books,onCellCommit:this.onCellCommit.bind(this),ref:t=>{this.spreadsheet_ref=t}}))(),n.createElement("div",{className:"books"},this.state.books.map(((t,e)=>n.createElement("div",{className:"book",key:t[1].value+e},n.createElement("div",{className:"bib"},n.createElement("a",{href:`https://calil.jp/book/${t[1].value}`,target:"_blank"},n.createElement("img",{src:"https://calil.jp/cover/"+t[1].value,alt:""})),n.createElement("span",{className:"title"},t[0].value),n.createElement("span",{className:"isbn"},t[1].value)),n.createElement("button",{onClick:this.delete.bind(this,e)},"削除"))))))}}l.render(n.createElement(b,null),document.getElementById("app"));
