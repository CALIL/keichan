!function(){function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(e)}function e(t,e){var o="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!o){if(Array.isArray(t)||(o=function(t,e){if(!t)return;if("string"==typeof t)return n(t,e);var o=Object.prototype.toString.call(t).slice(8,-1);"Object"===o&&t.constructor&&(o=t.constructor.name);if("Map"===o||"Set"===o)return Array.from(t);if("Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o))return n(t,e)}(t))||e&&t&&"number"==typeof t.length){o&&(t=o);var i=0,s=function(){};return{s:s,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,a=!0,u=!1;return{s:function(){o=o.call(t)},n:function(){var t=o.next();return a=t.done,t},e:function(t){u=!0,r=t},f:function(){try{a||null==o.return||o.return()}finally{if(u)throw r}}}}function n(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,o=new Array(e);n<e;n++)o[n]=t[n];return o}function o(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function s(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function r(t,e,n){return e&&s(t.prototype,e),n&&s(t,n),t}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&u(t,e)}function u(t,e){return(u=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function l(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,o=h(t);if(e){var i=h(this).constructor;n=Reflect.construct(o,arguments,i)}else n=o.apply(this,arguments);return c(this,n)}}function c(e,n){return!n||"object"!==t(n)&&"function"!=typeof n?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(e):n}function h(t){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}System.register(["./normalize_isbn-legacy.f42b1f7a.js","./vendor-legacy.ed8f06b0.js"],(function(){"use strict";var t,n,s,u,c,h,p,f,v;return{setters:[function(e){t=e.n},function(t){n=t.r,s=t.R,u=t.a,c=t.I,h=t.X,p=t.F,f=t.S,v=t.b}],execute:function(){var d=function(t){a(n,t);var e=l(n);function n(){var t;return i(this,n),(t=e.call(this)).state={},t}return r(n,[{key:"render",value:function(){var t=this;return s.createElement("div",{className:"book",onClick:function(){return t.props.open(t.props.book)}},this.props.book.isbn&&(this.props.count<10*this.props.updateCount||this.props.completed)?s.createElement("img",{src:"https://calil.jp/cover/".concat(this.props.book.isbn)}):null,s.createElement("div",null,s.createElement("div",{className:"title"},this.props.book.title),s.createElement("div",{className:"author"},this.props.book.author)))}}]),n}(n.exports.Component),m=["free","title","author","publisher","isbn","ndc","year_start","year_end","region"];function y(t){return u.get("https://unitrad.calil.jp/v1/"+t)}var b=function(){function t(e,n){i(this,t),o(this,"callback",void 0),o(this,"killed",void 0),o(this,"data",void 0),this.callback=n,this.killed=!1,this.search(e)}return r(t,[{key:"kill",value:function(){this.killed=!0}},{key:"search",value:function(t){var n=this;this.killed||y("search").query(function(t){var n,o={},i=e(m);try{for(i.s();!(n=i.n()).done;){var s=n.value;t.hasOwnProperty(s)&&""!==t[s]&&(o[s]=t[s])}}catch(r){i.e(r)}finally{i.f()}return o}(t)).end((function(e,o){e?setTimeout((function(){return n.search(t)}),1e3):n.receive(o.body)}))}},{key:"polling",value:function(){var t=this;this.killed||y("polling").query({uuid:this.data.uuid,version:this.data.version,diff:1,timeout:10}).end((function(e,n){null===n.body?setTimeout((function(){return t.polling()}),100):t.receive(n.body)}))}},{key:"receive",value:function(t){var n=this;if(!this.killed){if(t.books_diff){for(var o in Array.prototype.push.apply(this.data.books,t.books_diff.insert),t)t.hasOwnProperty(o)&&"books_diff"!==o&&(this.data[o]=t[o]);var i,s=e(t.books_diff.update);try{for(s.s();!(i=s.n()).done;){var r=i.value;for(var a in r)if(r.hasOwnProperty(a)&&"_idx"!==a)if(!0===Array.isArray(r[a]))Array.prototype.push.apply(this.data.books[r._idx][a],r[a]);else if(r[a]instanceof Object)for(var u in r[a])r[a].hasOwnProperty(u)&&(this.data.books[r._idx][a][u]=r[a][u]);else this.data.books[r._idx][a]=r[a]}}catch(l){s.e(l)}finally{s.f()}}else this.data=t;this.callback(this.data),!0===t.running?(console.log("[Unitrad] continue..."),1===t.version&&0===this.data.books.length?setTimeout((function(){return n.polling()}),20):setTimeout((function(){return n.polling()}),500)):console.log("[Unitrad] complete.")}}}]),t}();var g=function(t){a(n,t);var e=l(n);function n(t){var o;return i(this,n),(o=e.call(this,t)).api=null,o.prevQuery="",o.state={loading:!1,running:!1,books:[],message:"",hint:"",updateCount:0},o}return r(n,[{key:"kill",value:function(){this.api&&(this.api.kill(),this.setState({updateCount:0,running:!1}))}},{key:"componentDidMount",value:function(){var t=this;this.props.query===this.prevQuery&&(this.state.showResult=!0),""!=this.props.query&&this.props.query!=this.prevQuery&&(this.kill(),this.prevQuery=this.props.query,this.api=new b({free:this.props.query,region:this.props.region},(function(e){var n=[];e.books.slice(0,300).map((function(t){if(t.isbn&&t.isbn.length>=10){var e=c.parse(t.isbn);t.isbn=e?e.asIsbn13():t.isbn.replace(/-/g,""),n.push(t)}else t.isbn=void 0,n.push(t)}));var o=e.running;n.length>20&&(o=!1,t.kill()),t.setState({books:n,loading:o&&n.length<10,running:o,notFound:!1===o&&0===n.length,updateCount:t.state.updateCount+1,showResult:!0})})))}},{key:"componentDidUpdate",value:function(){this.componentDidMount()}},{key:"componentWillUnmount",value:function(){this.kill()}},{key:"render",value:function(){var t=this,e=0;return s.createElement("div",{className:"suggest"},this.state.books.length>0?s.createElement("div",{className:"results"},this.state.books.map((function(n){return e+=1,s.createElement(d,{book:n,key:n.id,count:e,updateCount:t.state.updateCount,completed:!t.state.running,open:function(e){t.props.open(e)}})}))):this.state.running?s.createElement("div",{className:"message"},"検索中..."):null,this.state.notFound?s.createElement("div",{className:"message"},"見つかりませんでした"):null)}}]),n}(n.exports.Component),k=function(t){a(n,t);var e=l(n);function n(t){var o;return i(this,n),(o=e.call(this,t)).state={isRecognition:!1},o}return r(n,[{key:"start",value:function(){var t=this,e=new webkitSpeechRecognition;e.lang="ja-JP",this.setState({isRecognition:!0}),e.onend=function(){console.log("on end"),e.stop(),t.setState({isRecognition:!1})},e.onresult=function(e){e.results.length>0&&t.props.onEnd(e.results[0][0].transcript)},e.onstart=function(){console.log("on start")},e.onspeechstart=function(){console.log("on speech start")},e.onspeechend=function(){console.log("on speech end")},e.onsoundend=function(){console.log("on sound end")},e.onaudiostart=function(){console.log("on audio start")},e.onaudioend=function(){console.log("on audio end")},e.start()}},{key:"render",value:function(){return"webkitSpeechRecognition"in window?s.createElement("span",{className:"speech",onClick:this.start.bind(this)},this.state.isRecognition?"認識中…":s.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 352 512"},s.createElement("path",{d:"M176 352c53.02 0 96-42.98 96-96V96c0-53.02-42.98-96-96-96S80 42.98 80 96v160c0 53.02 42.98 96 96 96zm160-160h-16c-8.84 0-16 7.16-16 16v48c0 74.8-64.49 134.82-140.79 127.38C96.71 376.89 48 317.11 48 250.3V208c0-8.84-7.16-16-16-16H16c-8.84 0-16 7.16-16 16v40.16c0 89.64 63.97 169.55 152 181.69V464H96c-8.84 0-16 7.16-16 16v16c0 8.84 7.16 16 16 16h160c8.84 0 16-7.16 16-16v-16c0-8.84-7.16-16-16-16h-56v-33.77C285.71 418.47 352 344.9 352 256v-48c0-8.84-7.16-16-16-16z"}))):null}}]),n}(n.exports.Component),S="recipe",w=function(e){a(o,e);var n=l(o);function o(t){var e;return i(this,o),(e=n.call(this,t)).state={books:[],invalidISBN:!1,scanner:!1,notFound:!1,query:"",showSuggest:!1},e.textInput=null,e.setTextInputRef=function(t){e.textInput=t},e.setTextInput=function(t){e.textInput&&(e.textInput.value=t)},e.timer=null,e.str="",e.prevISBN=null,e}return r(o,[{key:"load",value:function(){var t=localStorage.getItem("spreadsheet");if(t){var e=JSON.parse(t);this.setState({books:e})}}},{key:"save",value:function(){localStorage.setItem("spreadsheet",JSON.stringify(this.state.books))}},{key:"speak",value:function(t){if("speechSynthesis"in window){var e=new SpeechSynthesisUtterance(t);e.rate=1.5,speechSynthesis.speak(e)}}},{key:"speech",value:function(t){var e;t&&(this.setTextInput(t),null===(e=this.textInput)||void 0===e||e.focus(),this.setState({query:t,invalidISBN:!1,showSuggest:!0}))}},{key:"pushBook",value:function(t,e){var n;this.prevISBN!==e&&(this.state.books.unshift([{value:t},{value:e},{value:""},{value:""}]),this.setState({notFound:!1}),this.save(),this.speak(t),e&&(this.prevISBN=e),null===(n=this.textInput)||void 0===n||n.focus())}},{key:"addBook",value:function(t){var e=this;new b({isbn:t,region:S},(function(t){if(t.count>=1){var n=t.books[0];e.pushBook(n.title,n.isbn)}else console.log("not found"),e.setState({notFound:!0})}))}},{key:"selectBook",value:function(t){this.setState({showSuggest:!1}),this.pushBook(t.title,t.isbn)}},{key:"submit",value:function(e){var n;e.preventDefault();var o=null===(n=this.textInput)||void 0===n?void 0:n.value;o&&o.length>=10?t(o)?(this.setState({invalidISBN:!1,showSuggest:!1}),this.setTextInput(o),this.addBook(o)):this.setState({invalidISBN:!0,showSuggest:!1}):this.setState({query:o,invalidISBN:!1,showSuggest:!0})}},{key:"delete",value:function(t){var e,n=this.state.books.filter((function(e,n){return n!==t}));this.setState({books:n},this.save),null===(e=this.textInput)||void 0===e||e.focus()}},{key:"onKeyDown",value:function(e){var n=this;if("Spreadsheet__data-editor"!==e.target.parentNode.className){var o=e||window.event,i=o.keyCode||o.which||o.charCode;"Enter"===e.key||13===i?(this.str.length>=10&&(t(this.str)?(this.setState({invalidISBN:!1,scanner:!0}),this.setTextInput(this.str),this.addBook(this.str),console.log("scanned:",this.str)):this.setState({invalidISBN:!0})),this.timer&&clearTimeout(this.timer),this.str=""):(1===e.key.length?this.str+=e.key:this.str="",this.timer&&clearTimeout(this.timer),this.timer=setTimeout((function(){console.log("clear"),n.str.length>=10&&(t(n.str)?(n.setState({invalidISBN:!1}),n.setTextInput(n.str),n.addBook(n.str)):n.setState({invalidISBN:!0})),n.str=""}),300))}}},{key:"componentDidMount",value:function(){var t,e=this;this.load(),null===(t=this.textInput)||void 0===t||t.focus(),window.document.addEventListener("keydown",this.onKeyDown.bind(this)),document.body.addEventListener("click",(function(t){t.target.closest(".inputForm")||e.setState({showSuggest:!1})}))}},{key:"onCellCommit",value:function(t,e,n){var o,i,s,r=null===(o=this.spreadsheet_ref)||void 0===o||null===(i=o.prevState)||void 0===i||null===(s=i.lastChanged)||void 0===s?void 0:s.row;n&&(this.state.books.map((function(o,i){i===r&&o[n.column].value===t.value&&(o[n.column].value=e.value)})),this.setState({}),this.save())}},{key:"downloadXSLX",value:function(){var t=h.utils.book_new();t.Props={Title:"",Subject:"",Author:"",CreatedDate:new Date},t.SheetNames.push("Test Sheet");var e=[];this.state.books.map((function(t){e.push([t[0].value,t[1].value,t[2].value,t[3].value])}));var n=h.utils.aoa_to_sheet(e);t.Sheets["Test Sheet"]=n;var o=h.write(t,{bookType:"xlsx",type:"binary"});p.exports.saveAs(new Blob([function(t){for(var e=new ArrayBuffer(t.length),n=new Uint8Array(e),o=0;o<t.length;o++)n[o]=255&t.charCodeAt(o);return e}(o)],{type:"application/octet-stream"}),"test.xlsx")}},{key:"render",value:function(){var t=this;return s.createElement(s.Fragment,null,s.createElement("div",{className:this.state.showSuggest?"show_suggest":"hide_suggest"},s.createElement(g,{region:S,open:this.selectBook.bind(this),query:this.state.query})),s.createElement("header",null,s.createElement("form",{className:"inputForm",onSubmit:this.submit.bind(this)},s.createElement("input",{type:"text",placeholder:"キーワード or ISBN...",ref:this.setTextInputRef,inputMode:"url",autoFocus:!0}),s.createElement("button",{onClick:this.submit.bind(this)},"検索"),s.createElement(k,{onEnd:this.speech.bind(this)})),function(){if(t.state.books.length>0)return s.createElement("div",{className:"right"},s.createElement("div",{className:"count"},t.state.books.length,"冊"),s.createElement("button",{onClick:t.downloadXSLX.bind(t)},"Excelをダウンロード"))}()),function(){if(t.state.invalidISBN)return s.createElement("div",{className:"warning"},s.createElement("h3",null,"ISBNが正しくありません"))}(),function(){if(t.state.notFound)return s.createElement("div",{className:"warning"},s.createElement("h3",null,"該当する本が見つかりませんでした"))}(),function(){if(t.state.scanner)return s.createElement("div",{className:"connected"},s.createElement("h3",null,"バーコードリーダーが接続されました"))}(),0===t.state.books.length?s.createElement("div",{className:"description",onClick:function(){var e;return null===(e=t.textInput)||void 0===e?void 0:e.focus()}},s.createElement("div",null,s.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"},s.createElement("path",{d:"M0 448V64h18v384H0zm26.857-.273V64H36v383.727h-9.143zm27.143 0V64h8.857v383.727H54zm44.857 0V64h8.857v383.727h-8.857zm36 0V64h17.714v383.727h-17.714zm44.857 0V64h8.857v383.727h-8.857zm18 0V64h8.857v383.727h-8.857zm18 0V64h8.857v383.727h-8.857zm35.715 0V64h18v383.727h-18zm44.857 0V64h18v383.727h-18zm35.999 0V64h18.001v383.727h-18.001zm36.001 0V64h18.001v383.727h-18.001zm26.857 0V64h18v383.727h-18zm45.143 0V64h26.857v383.727h-26.857zm35.714 0V64h9.143v383.727H476zm18 .273V64h18v384h-18z"})),"ISBNを入力するか、バーコードをスキャンしてください")):s.createElement(f,{data:t.state.books,onCellCommit:t.onCellCommit.bind(t),ref:function(e){t.spreadsheet_ref=e}}),s.createElement("div",{className:"books"},this.state.books.map((function(e,n){return s.createElement("div",{className:"book",key:e[1].value+n},s.createElement("div",{className:"bib"},s.createElement("a",{href:"https://calil.jp/book/".concat(e[1].value),target:"_blank"},s.createElement("img",{src:"https://calil.jp/cover/"+e[1].value,alt:""})),s.createElement("span",{className:"title"},e[0].value),s.createElement("span",{className:"isbn"},e[1].value)),s.createElement("button",{onClick:t.delete.bind(t,n)},"削除"))}))))}}]),o}(n.exports.Component);v.render(s.createElement(w,null),document.getElementById("app"))}}}))}();
