import("data:text/javascript;base64,Cg==");import{n as e,a as t}from"./api.fe1db442.js";import{r as s,R as a,O as n,c as l,C as i,E as r,T as o,l as c,a as u}from"./vendor.4ba88960.js";let m="",h=null;const p=()=>{const[u,p]=s.exports.useState([]),[b,d]=s.exports.useState(null),[E,f]=s.exports.useState([]),[g,v]=s.exports.useState(null),[x,y]=s.exports.useState([]);s.exports.useState("gk-xxxxxxxxxxxxxxx");const[w,k]=s.exports.useState("isbn"),[T,N]=s.exports.useState(!0),[S,C]=s.exports.useState({show:!1,message:""}),j=e=>((e,t)=>{const s=e||window.event,a=s.keyCode||s.which||s.charCode;"Enter"===e.key||13===a?(t(m),h&&clearTimeout(h),m=""):(1===e.key.length?m+=e.key:"Shift"===e.key||(m=""),h&&clearTimeout(h),h=setTimeout((()=>{t(m),m=""}),300))})(e,z);s.exports.useEffect((()=>(window.addEventListener("keydown",j),()=>{window.removeEventListener("keydown",j)})),[w,u,T]),s.exports.useEffect((()=>{const e=u[u.length-1];d(e)}),[u]),s.exports.useEffect((()=>{setTimeout((()=>{C({show:!1,message:""})}),5e3)}),[S]);const z=async t=>{const s=[];if(!1===T)return;const a=e(t);if(a){s.push("本のバーコードが読まれました。"),s.push(t);const e=await D(a);if(e)if(s.push("本が見つかりました！"),"isbn"===w)e.id=e.isbn,p([...u,e]);else if("management"===w){const t=[...u],a=t[t.length-1];a&&!a.title?(a.title=e.title,a.author=e.author,a.publisher=e.publisher,a.isbn=e.isbn,a.tags=e.tags,a.bibHash=e.bibHash,console.log(t),p(t)):(C({show:!0,message:"次は資料コードのバーコードを読んでください。"}),s.push("!! 資料コードのバーコードを読んでください。"))}}else{if(null!==t.match(/^192/))return s.push("192で始まるバーコードのため、書籍JANコード(下段)と判断して、処理しません。"),void f([...E,...s]);if(null===t.match(/[a-zA-Z0-9]+/))return s.push("英数字以外のキーが入力されたました。処理しません。"),void f([...E,...s]);t.match(/^[a-zA-Z](\d+)[a-zA-Z]$/)&&(t=RegExp.$1,s.push("codabarの制御コードを検出しました。")),"isbn"===w&&(k("management"),s.push("資料コードが読み込まれたため、資料コード用のモードに切り替えます。"));const e=u[u.length-1];if(console.log(e),e&&!e.title)return e.id=t,p([...u]),s.push("別の資料コードが読み込まれたので、上書きしました。"),void f([...E,...s]);if(u.filter((e=>e.id===t)).length>0)return C({show:!0,message:"すでに登録済みの資料コードです"}),s.push("すでに登録済みの資料コードです"),void f([...E,...s]);if(p([...u,{id:t}]),e&&e.title){v(e);const t=await A(e);y(t)}}f([...E,...s]),N(!1),setTimeout((()=>N(!0)),100)},B=e=>e.isbn,D=async s=>(v(null),y([]),new Promise((async(a,n)=>{const l=new t({isbn:s,region:"recipe"},(async t=>{if(t.count>=1){l.kill();const s=t.books[0],n={id:s.id,title:s.title,author:s.author,publisher:s.publisher,pubdate:s.pubdate,isbn:s.isbn,tags:[]};n.bibHash=B(n);let i=c.parse(e(n.isbn));n.isbn=i.asIsbn13();const r=await H([n.isbn]);null!==r[0]?a(r[0]):a(n)}else!1===t.running&&0===t.count&&n()}))}))),A=async s=>{const a=s.author.split(",")[0],n=s.publisher,l=s.pubdate;return new Promise((async(i,r)=>{let o=new t({author:a,publisher:n,year_start:l,region:"recipe"},(async t=>{if(!o.killed&&(t.count>5&&o.kill(),console.log(t),t.count>=1)){const a=[];t.books.forEach((t=>{if(null===t.isbn)return;let s=0;t.pubdate&&(s="string"!=typeof t.pubdate?t.pubdate:Number(t.pubdate.split("/")[0].split(".")[0]));let n=c.parse(e(t.isbn)),l=null;try{l=n.asIsbn13()}catch{}l&&a.push({title:t.title+" "+t.volume,author:t.author.split(",")[0],publisher:t.publisher,isbn:l,pubdate:s})})),a.sort((function(e,t){return e.isbn<t.isbn?-1:e.isbn>t.isbn?1:0}));let n=[];const l=[];let r=!1;a.forEach((e=>{e.isbn!==s.isbn&&(r?n.push(e):l.push(e)),e.isbn===s.isbn&&(r=!0)})),n=n.concat(l);const o=[];n.forEach((e=>{o.push(e.isbn)}));const u=await H(o);i(u)}}))}))},H=async e=>new Promise((async(t,s)=>{const a=await fetch("https://api.openBD.jp/v1/get?isbn="+e.join(",")).then((e=>e.json())),n=[];a.forEach((e=>{if(e){const t=[];try{e.onix.DescriptiveDetail.Collection.TitleDetail.TitleElement.forEach(((e,s)=>{t.includes(e.TitleText.content)||t.push(e.TitleText.content)}))}catch{}let s=e.summary.volume;try{""===s&&(s=e.onix.DescriptiveDetail.TitleDetail.TitleElement.PartNumber)}catch{}const a={title:[e.summary.title,s].join(" "),author:e.summary.author,publisher:e.summary.publisher,isbn:e.summary.isbn,pubdate:e.summary.pubdate,cover:e.summary.cover,tags:t};a.bibHash=B(a),n.push(a)}})),t(n)}));return a.createElement("div",{id:"debug"},a.createElement(n,{isOpen:S.show,onClose:()=>C({show:!1,message:""}),hasBackdrop:!1},a.createElement("div",{className:"bp3-card bp3-elevation-4 bp3-overlay-content"},a.createElement(l,{icon:"tick",size:25,color:"#000000"}),S.message)),a.createElement("header",null,a.createElement("h1",null,"カーリルtoolbox: keichan","management"===w?a.createElement("span",{className:"mode"},"資料コード"):null)),a.createElement("main",null,a.createElement("div",{className:"main"},u.slice().reverse().map(((e,t)=>a.createElement(a.Fragment,null,"management"===w?a.createElement(i,{key:"managementCode",className:"card active",interactive:!0,elevation:r.TWO},a.createElement("img",{src:`https://img.shields.io/badge/%E7%AE%A1%E7%90%86%E3%83%90%E3%83%BC%E3%82%B3%E3%83%BC%E3%83%89-${e.id}-brightgreen`,alt:""}),a.createElement(l,{icon:"delete",size:25,color:"#ffffff"})):null,e.title?a.createElement(i,{key:e.bibHash,className:"card indent",interactive:!0,elevation:r.TWO},a.createElement("div",null,e.cover?a.createElement("img",{className:"thumbnail",src:e.cover,alt:""}):null,a.createElement("div",null,a.createElement("img",{src:`https://img.shields.io/badge/book-${e.isbn}-brightgreen`,alt:""}),a.createElement("h3",null,e.title))),a.createElement(l,{icon:"delete",size:25,color:"#ffffff"})):null))),g&&x.length>0?a.createElement("div",{className:"nextBook"},a.createElement("h2",null,"もしかして",a.createElement("span",null,"(",g.title,"より推定)")),a.createElement("div",{className:"cards"},x.map((e=>a.createElement(i,{key:e.isbn,className:"card",interactive:!0,elevation:r.TWO},a.createElement("div",{className:"card-header"},e.cover?a.createElement("img",{src:e.cover,alt:e.title}):null,a.createElement("div",null,a.createElement("h3",null,[e.title,e.volume].join(" ")),a.createElement("p",{className:"author"},e.author),e.tags.map((e=>a.createElement(o,null,e))),a.createElement("p",null,e.isbn))),a.createElement(l,{icon:"add",size:25,color:"#ffffff"})))))):null),a.createElement("div",{className:"debug"},a.createElement("div",{className:"logs"},E.map(((e,t)=>a.createElement("div",{key:"log"+t},e)))))))};u.render(a.createElement(p,null),document.getElementById("app"));
