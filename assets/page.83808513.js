import("data:text/javascript;base64,Cg==");import{n as e,a as t}from"./api.462ba066.js";import{r as n,R as a,T as l,C as s,E as i,c,l as r,a as o}from"./vendor.de6f6c87.js";let m="",u=null;const p=()=>{const[o,p]=n.exports.useState([]),[b,h]=n.exports.useState(null),[d,E]=n.exports.useState(null),[f,g]=n.exports.useState([]);n.exports.useState("gk-xxxxxxxxxxxxxxx");const[y,v]=n.exports.useState("isbn"),x=e=>((e,t)=>{console.log("onKeyDown");const n=e||window.event,a=n.keyCode||n.which||n.charCode;"Enter"===e.key||13===a?(t(m),u&&clearTimeout(u),m=""):(1===e.key.length?m+=e.key:"Shift"===e.key||(m=""),u&&clearTimeout(u),u=setTimeout((()=>{t(m),m=""}),300))})(e,k);n.exports.useEffect((()=>(window.addEventListener("keydown",x),()=>{window.removeEventListener("keydown",x)})),[y,o]),n.exports.useEffect((()=>{const e=o[o.length-1];h(e)}),[o]);const k=async t=>{const n=e(t);if(n){const e=await N(n);if(e)if(console.log(e),e.type="book","isbn"===y){const t={id:e.isbn,items:[e]};p([...o,t])}else if("management"===y){const t=[...o],n=t[t.length-1];0===n.items.length?(n.items.push(e),console.log(t),p(t)):alert("次は資料番号のバーコードを読んでください")}}else{if(null!==t.match(/^192/))return;v("management"),p([...o,{id:t,items:[]}]);const e=o[o.length-1];if(console.log(e),e&&e.items.length>0){const t=e.items.filter((e=>"book"===e.type));if(console.log(t),t.length>0){E(t[0]);const e=await T(t[0]);g(e)}}}},w=e=>e.isbn,N=async n=>(E(null),g([]),new Promise((async(a,l)=>{const s=new t({isbn:n,region:"recipe"},(async t=>{if(t.count>=1){s.kill();const n=t.books[0],l={id:n.id,title:n.title,author:n.author,publisher:n.publisher,pubdate:n.pubdate,isbn:n.isbn,tags:[]};l.bibHash=w(l);let i=r.parse(e(l.isbn));l.isbn=i.asIsbn13();const c=await j([l.isbn]);null!==c[0]?a(c[0]):a(l)}else!1===t.running&&0===t.count&&l()}))}))),T=async n=>{const a=n.author.split(",")[0],l=n.publisher,s=n.pubdate;return new Promise((async(i,c)=>{let o=new t({author:a,publisher:l,year_start:s,region:"recipe"},(async t=>{if(!o.killed&&(t.count>5&&o.kill(),console.log(t),t.count>=1)){const a=[];t.books.forEach((t=>{if(null===t.isbn)return;let n=0;t.pubdate&&(n="string"!=typeof t.pubdate?t.pubdate:Number(t.pubdate.split("/")[0].split(".")[0]));let l=r.parse(e(t.isbn)),s=null;try{s=l.asIsbn13()}catch{}s&&a.push({title:t.title+" "+t.volume,author:t.author.split(",")[0],publisher:t.publisher,isbn:s,pubdate:n})})),a.sort((function(e,t){return e.isbn<t.isbn?-1:e.isbn>t.isbn?1:0}));let l=[];const s=[];let c=!1;a.forEach((e=>{e.isbn!==n.isbn&&(c?l.push(e):s.push(e)),e.isbn===n.isbn&&(c=!0)})),l=l.concat(s);const o=[];l.forEach((e=>{o.push(e.isbn)}));const m=await j(o);i(m)}}))}))},j=async e=>new Promise((async(t,n)=>{const a=await fetch("https://api.openBD.jp/v1/get?isbn="+e.join(",")).then((e=>e.json())),l=[];a.forEach((e=>{if(e){const t=[];try{e.onix.DescriptiveDetail.Collection.TitleDetail.TitleElement.forEach(((e,n)=>{t.includes(e.TitleText.content)||t.push(e.TitleText.content)}))}catch{}let n=e.summary.volume;try{""===n&&(n=e.onix.DescriptiveDetail.TitleDetail.TitleElement.PartNumber)}catch{}const a={title:[e.summary.title,n].join(" "),author:e.summary.author,publisher:e.summary.publisher,isbn:e.summary.isbn,pubdate:e.summary.pubdate,cover:e.summary.cover,tags:t};a.bibHash=w(a),l.push(a)}})),t(l)}));return a.createElement("div",{id:"new"},a.createElement("header",null,a.createElement("h1",null,"カーリルtoolbox: keichan","management"===y?a.createElement("span",{className:"mode"},"資料コード"):null)),a.createElement("main",null,a.createElement("div",{className:"left"},o.slice().reverse().map(((e,t)=>a.createElement("div",{className:"barcode"},a.createElement(l,{large:!0,className:"tag"},e.id),e.items.map(((e,t)=>{if("book"===e.type)return a.createElement("p",null,e.title)})))))),a.createElement("div",{className:"main"},b?a.createElement(a.Fragment,null,"management"===y?a.createElement(s,{key:"managementCode",className:"card active",interactive:!0,elevation:i.TWO},a.createElement("div",null,a.createElement(l,{className:"tag",large:!0},b.id),a.createElement(l,{className:"tag"},"管理バーコード")),a.createElement(c,{icon:"delete",size:25,color:"#ffffff"})):null,b.items.map(((e,t)=>{if("book"===e.type)return a.createElement(s,{key:e.bibHash,className:"card indent",interactive:!0,elevation:i.TWO},a.createElement("div",null,a.createElement(l,{className:"tag"},e.type),a.createElement(l,{className:"tag"},e.isbn),a.createElement("h3",null,e.title),e.cover?a.createElement("img",{className:"thumbnail",src:e.cover,alt:""}):null),a.createElement(c,{icon:"delete",size:25,color:"#ffffff"}))}))):null,d&&f.length>0?a.createElement("div",{className:"nextBook"},a.createElement("h2",null,"もしかして",a.createElement("span",null,"(",d.title,"より推定)")),a.createElement("div",{className:"cards"},f.map((e=>a.createElement(s,{key:e.isbn,className:"card",interactive:!0,elevation:i.TWO},a.createElement("div",{className:"card-header"},e.cover?a.createElement("img",{src:e.cover,alt:e.title}):null,a.createElement("div",null,a.createElement("h3",null,[e.title,e.volume].join(" ")),a.createElement("p",{className:"author"},e.author),e.tags.map((e=>a.createElement(l,null,e))),a.createElement("p",null,e.isbn))),a.createElement(c,{icon:"add",size:25,color:"#ffffff"})))))):null)))};o.render(a.createElement(p,null),document.getElementById("app"));
