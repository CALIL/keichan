import("data:text/javascript;base64,Cg==");import{n as e,a as t}from"./api.fdc05c5b.js";import{R as s,C as n,E as a,T as l,c as i,r,O as c,l as o,a as m}from"./vendor.4ba88960.js";const h=e=>{const t=e.book;return s.createElement(n,{key:t.isbn,className:"card",interactive:!0,elevation:a.TWO},s.createElement("div",{className:"card-header"},t.cover?s.createElement("img",{src:t.cover,alt:t.title}):null,s.createElement("div",null,s.createElement("h3",null,[t.title,t.volume].join(" ")),s.createElement("p",{className:"author"},t.author),t.tags.map((e=>s.createElement(l,null,e))),s.createElement("p",null,t.isbn))),s.createElement(i,{icon:"add",size:25,color:"#ffffff"}))};let u="",p=null;const v=()=>{const[l,m]=r.exports.useState([]),[v,b]=r.exports.useState(null),[d,E]=r.exports.useState([]),[g,f]=r.exports.useState(null),[x,z]=r.exports.useState([]);r.exports.useState("gk-xxxxxxxxxxxxxxx");const[w,y]=r.exports.useState("isbn"),[V,k]=r.exports.useState(!0),[N,T]=r.exports.useState({show:!1,message:""}),H=e=>((e,t)=>{const s=e||window.event,n=s.keyCode||s.which||s.charCode;"Enter"===e.key||13===n?(t(u),p&&clearTimeout(p),u=""):(1===e.key.length?u+=e.key:"Shift"===e.key||(u=""),p&&clearTimeout(p),p=setTimeout((()=>{t(u),u=""}),300))})(e,B);r.exports.useEffect((()=>(window.addEventListener("keydown",H),()=>{window.removeEventListener("keydown",H)})),[w,l,V,d]),r.exports.useEffect((()=>{const e=l[l.length-1];b(e)}),[l]);const S=r.exports.useRef(null);r.exports.useEffect((()=>{if(S.current){const e=S.current;console.log(e),e.scrollTop=e.scrollHeight}}),[d]),r.exports.useEffect((()=>{setTimeout((()=>{T({show:!1,message:""})}),5e3)}),[N]);const B=async t=>{const s=[];if(!1===V)return;const n=e(t);if(n){s.push("本のバーコードが読まれました。"),s.push(t);const e=await C(n);if(e)if(s.push("本が見つかりました！"),"isbn"===w){e.id=e.isbn,m([...l,e]);const t=l[l.length-1];if(t&&t.title){s.push(`一つ前の本、「${t.title}」から次の本の候補を探します。`),f(t);const e=await $(t);z(e),e.length>0&&s.push(`候補の本が${e.length}冊みつかりました。`)}}else if("management"===w){const t=[...l],n=t[t.length-1];n&&!n.title?(n.title=e.title,n.author=e.author,n.publisher=e.publisher,n.isbn=e.isbn,n.cover=e.cover,n.tags=e.tags,n.bibHash=e.bibHash,m(t)):(T({show:!0,message:"次は資料コードのバーコードを読んでください。"}),s.push("!! 資料コードのバーコードを読んでください。"))}}else{if(null!==t.match(/^192/))return s.push("192で始まるバーコードのため、書籍JANコード(下段)と判断して、処理しません。"),void E([...d,...s]);if(null===t.match(/[a-zA-Z0-9]+/))return s.push("英数字以外のキーが入力されました。処理しません。"),void E([...d,...s]);t.match(/^[a-zA-Z](\d+)[a-zA-Z]$/)&&(t=RegExp.$1,s.push("codabarの制御コードを検出しました。")),"isbn"===w&&(y("management"),s.push("資料コードが読み込まれたため、資料コード用のモードに切り替えます。")),s.push(t);const e=l[l.length-1];if(e&&!e.title)return e.id=t,m([...l]),s.push("! 別の資料コードが読み込まれたので、新しい資料コードに変更しました。"),void E([...d,...s]);if(l.filter((e=>e.id===t)).length>0)return T({show:!0,message:"すでに登録済みの資料コードです"}),s.push("!! すでに登録済みの資料コードです"),void E([...d,...s]);if(m([...l,{id:t}]),e&&e.title){s.push(`一つ前の本、「${e.title}」から次の本の候補を探します。`),f(e);const t=await $(e);z(t),t.length>0&&s.push(`候補の本が${t.length}冊みつかりました。`)}}E([...d,...s]),k(!1),setTimeout((()=>k(!0)),100)},j=e=>e.isbn,C=async s=>(f(null),z([]),new Promise((async(n,a)=>{const l=new t({isbn:s,region:"recipe"},(async t=>{if(t.count>=1){l.kill();const s=t.books[0],a={id:s.id,title:s.title,author:s.author,publisher:s.publisher,pubdate:s.pubdate,isbn:s.isbn,tags:[]};a.bibHash=j(a);let i=o.parse(e(a.isbn));a.isbn=i.asIsbn13();const r=await D([a.isbn]);null!==r[0]?n(r[0]):n(a)}else!1===t.running&&0===t.count&&a()}))}))),$=async s=>{const n=s.author.split(",")[0],a=s.publisher,l=s.pubdate;return new Promise((async(i,r)=>{let c=new t({author:n,publisher:a,year_start:l,region:"recipe"},(async t=>{if(!c.killed&&(t.count>5&&c.kill(),console.log(t),t.count>=1)){const n=[];t.books.forEach((t=>{if(null===t.isbn)return;let s=0;t.pubdate&&(s="string"!=typeof t.pubdate?t.pubdate:Number(t.pubdate.split("/")[0].split(".")[0]));let a=o.parse(e(t.isbn)),l=null;try{l=a.asIsbn13()}catch{}l&&n.push({title:t.title+" "+t.volume,author:t.author.split(",")[0],publisher:t.publisher,isbn:l,pubdate:s})})),n.sort((function(e,t){return e.isbn<t.isbn?-1:e.isbn>t.isbn?1:0}));let a=[];const l=[];let r=!1;n.forEach((e=>{e.isbn!==s.isbn&&(r?a.push(e):l.push(e)),e.isbn===s.isbn&&(r=!0)})),a=a.concat(l);const c=[];a.forEach((e=>{c.push(e.isbn)}));const m=await D(c);i(m)}}))}))},D=async e=>new Promise((async(t,s)=>{const n=await fetch("https://api.openBD.jp/v1/get?isbn="+e.join(",")).then((e=>e.json())),a=[];n.forEach((e=>{if(e){const t=[];try{e.onix.DescriptiveDetail.Collection.TitleDetail.TitleElement.forEach(((e,s)=>{t.includes(e.TitleText.content)||t.push(e.TitleText.content)}))}catch{}let s=e.summary.volume;try{""===s&&(s=e.onix.DescriptiveDetail.TitleDetail.TitleElement.PartNumber)}catch{}const n={title:[e.summary.title,s].join(" "),author:e.summary.author,publisher:e.summary.publisher,isbn:e.summary.isbn,pubdate:e.summary.pubdate,cover:e.summary.cover,tags:t};n.bibHash=j(n),a.push(n)}})),t(a)}));return s.createElement("div",{id:"debug"},s.createElement(c,{isOpen:N.show,onClose:()=>T({show:!1,message:""}),hasBackdrop:!1},s.createElement("div",{className:"bp3-card bp3-elevation-4 bp3-overlay-content"},s.createElement(i,{icon:"tick",size:25,color:"#000000"}),N.message)),s.createElement("header",null,s.createElement("h1",null,"カーリルtoolbox: keichan","management"===w?s.createElement("span",{className:"mode"},"資料コード"):null)),s.createElement("main",null,s.createElement("div",{className:"main"},0===l.length||l.length<=1&&l[l.length-1].title?s.createElement("div",{className:"description"},s.createElement("div",null,s.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"},s.createElement("path",{d:"M0 448V64h18v384H0zm26.857-.273V64H36v383.727h-9.143zm27.143 0V64h8.857v383.727H54zm44.857 0V64h8.857v383.727h-8.857zm36 0V64h17.714v383.727h-17.714zm44.857 0V64h8.857v383.727h-8.857zm18 0V64h8.857v383.727h-8.857zm18 0V64h8.857v383.727h-8.857zm35.715 0V64h18v383.727h-18zm44.857 0V64h18v383.727h-18zm35.999 0V64h18.001v383.727h-18.001zm36.001 0V64h18.001v383.727h-18.001zm26.857 0V64h18v383.727h-18zm45.143 0V64h26.857v383.727h-26.857zm35.714 0V64h9.143v383.727H476zm18 .273V64h18v384h-18z"})),"バーコードをスキャンしてください")):null,l.slice().reverse().map(((e,t)=>s.createElement(s.Fragment,null,"management"===w?s.createElement(n,{key:"managementCode",className:"card active",interactive:!0,elevation:a.TWO},s.createElement("img",{src:`https://img.shields.io/badge/%E8%B3%87%E6%96%99%E3%82%B3%E3%83%BC%E3%83%89-${e.id}-blue`,alt:""}),s.createElement(i,{icon:"delete",size:25,color:"#ffffff"})):null,e.title?s.createElement(n,{key:e.bibHash,className:"card indent",interactive:!0,elevation:a.TWO},s.createElement("div",null,e.cover?s.createElement("img",{className:"thumbnail",src:e.cover,alt:""}):null,s.createElement("div",null,s.createElement("img",{src:`https://img.shields.io/badge/book-${e.isbn}-brightgreen`,alt:""}),s.createElement("h3",null,e.title))),s.createElement(i,{icon:"delete",size:25,color:"#ffffff"})):s.createElement(s.Fragment,null,s.createElement("div",{className:"description"},s.createElement("div",null,s.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"},s.createElement("path",{d:"M0 448V64h18v384H0zm26.857-.273V64H36v383.727h-9.143zm27.143 0V64h8.857v383.727H54zm44.857 0V64h8.857v383.727h-8.857zm36 0V64h17.714v383.727h-17.714zm44.857 0V64h8.857v383.727h-8.857zm18 0V64h8.857v383.727h-8.857zm18 0V64h8.857v383.727h-8.857zm35.715 0V64h18v383.727h-18zm44.857 0V64h18v383.727h-18zm35.999 0V64h18.001v383.727h-18.001zm36.001 0V64h18.001v383.727h-18.001zm26.857 0V64h18v383.727h-18zm45.143 0V64h26.857v383.727h-26.857zm35.714 0V64h9.143v383.727H476zm18 .273V64h18v384h-18z"})),"紐つけるバーコードをスキャンしてください")),g&&x.length>0?s.createElement("div",{className:"nextBook"},s.createElement("h2",null,"もしかして",s.createElement("span",null,"(",g.title,"より推定)")),s.createElement("div",{className:"cards"},x.slice(0,4).map((e=>s.createElement(h,{book:e,key:e.isbn}))))):null))))),s.createElement("div",{className:"debug"},s.createElement("div",{className:"logs",ref:S},d.map(((e,t)=>s.createElement("div",{key:"log"+t},e)))))))};m.render(s.createElement(v,null),document.getElementById("app"));
