import("data:text/javascript;base64,Cg==");import{n as e,a as t}from"./api.36be3d2a.js";import{r as n,J as s,R as l,C as a,E as r,T as i,O as c,c as m,l as o,a as h}from"./vendor.2cc263d2.js";const u=e=>{const t=e.book,c=n.exports.useRef(null);return n.exports.useEffect((()=>{s(c.current,t.isbn,{format:"codabar",width:1.25,height:26,margin:10,fontSize:12})}),[]),l.createElement(a,{key:t.isbn,className:"card",interactive:!0,elevation:r.TWO},l.createElement("div",{className:"card-header"},t.cover?l.createElement("img",{src:t.cover,alt:t.title}):null,l.createElement("div",null,l.createElement("h3",null,[t.title,t.volume].join(" ")),l.createElement("p",{className:"author"},t.author),t.tags.map((e=>l.createElement(i,null,e))))),l.createElement("svg",{ref:c,xmlns:"http://www.w3.org/2000/svg",version:"1.1"}))};let p="",v=null;const d=()=>{const[s,i]=n.exports.useState([]),[h,d]=n.exports.useState(null),[E,b]=n.exports.useState([]),[g,f]=n.exports.useState(null),[z,y]=n.exports.useState([]);n.exports.useState("gk-xxxxxxxxxxxxxxx");const[x,V]=n.exports.useState("isbn"),[w,k]=n.exports.useState(!0),[N,S]=n.exports.useState({show:!1,message:""}),T=e=>((e,t)=>{const n=e||window.event,s=n.keyCode||n.which||n.charCode;"Enter"===e.key||13===s?(t(p),v&&clearTimeout(v),p=""):(1===e.key.length?p+=e.key:"Shift"===e.key||(p=""),v&&clearTimeout(v),v=setTimeout((()=>{t(p),p=""}),300))})(e,B);n.exports.useEffect((()=>(window.addEventListener("keydown",T),()=>{window.removeEventListener("keydown",T)})),[x,s,w,E]),n.exports.useEffect((()=>{const e=s[s.length-1];d(e)}),[s]);const H=n.exports.useRef(null);n.exports.useEffect((()=>{if(H.current){const e=H.current;console.log(e),e.scrollTop=e.scrollHeight}}),[E]),n.exports.useEffect((()=>{setTimeout((()=>{S({show:!1,message:""})}),5e3)}),[N]);const C=n.exports.useRef(null);n.exports.useEffect((()=>{setInterval((()=>{C.current&&(C.current.style.display="none",setTimeout((()=>{C.current.style.display="inline"}),500))}),1e3)}),[!0]);const B=async t=>{const n=[];if(!1===w)return;const a=e(t);if(a){n.push("ISBNのバーコードが読まれました。"),n.push(l.createElement("span",{style:{fontFamily:'"Conv_OCRB", Sans-Serif'}},t));const e=await O(a);if(e)if(n.push("本が見つかりました！"),"isbn"===x){e.id=e.isbn,i([...s,e]);const t=s[s.length-1];if(t&&t.title){n.push(`一つ前の本、「${t.title}」から次の本の候補を探します。`),f(t);const e=await R(t);y(e),e.length>0&&n.push(`候補の本が${e.length}冊みつかりました。`)}}else if("management"===x){const t=[...s],a=t[t.length-1];a&&!a.title?(a.title=e.title,a.author=e.author,a.publisher=e.publisher,a.isbn=e.isbn,a.cover=e.cover,a.tags=e.tags,a.bibHash=e.bibHash,i(t)):(S({show:!0,message:"次は資料コードのバーコードを読んでください。"}),n.push(l.createElement(l.Fragment,null,l.createElement("span",{style:{color:"red"}},"!!"),l.createElement("span",null," 資料コードのバーコードを読んでください。"))))}}else{if(t.length>20)return n.push(l.createElement("span",{style:{fontFamily:'"Conv_OCRB", Sans-Serif'}},t)),n.push(l.createElement(l.Fragment,null,l.createElement("span",{style:{color:"red"}},"!!"),l.createElement("span",null," 資料コードが長すぎます。バーコードの連続読み取りと判断して、処理しません。"))),void b([...E,...n]);if(null!==t.match(/^192/))return n.push(l.createElement("span",{style:{fontFamily:'"Conv_OCRB", Sans-Serif'}},t)),n.push("192で始まるバーコードのため、書籍JANコード(下段)と判断して、処理しません。"),void b([...E,...n]);if(null!==t.match(/^491/))return n.push(l.createElement("span",{style:{fontFamily:'"Conv_OCRB", Sans-Serif'}},t)),n.push("491で始まるバーコードのため、雑誌コードと判断して、処理しません。"),void b([...E,...n]);if(null===t.match(/[a-zA-Z0-9]+/))return n.push("英数字以外のキーが入力されました。処理しません。"),void b([...E,...n]);if(t.match(/[a-zA-Z]+/))return n.push("英数字のみが入力されました。処理しません。"),void b([...E,...n]);t.match(/^[a-zA-Z](\d+)[a-zA-Z]$/)&&(t=RegExp.$1,n.push("codabarの制御コードを検出しました。")),"isbn"===x&&(V("management"),n.push("資料コードが読み込まれたため、資料コード用のモードに切り替えます。")),n.push(t);const e=s[s.length-1];if(e&&!e.title)return e.id=t,i([...s]),n.push(l.createElement(l.Fragment,null,l.createElement("span",{style:{color:"lightgreen"}},"!"),l.createElement("span",null," 別の資料コードが読み込まれたので、新しい資料コードに変更しました。"))),void b([...E,...n]);if(s.filter((e=>e.id===t)).length>0)return S({show:!0,message:"すでに登録済みの資料コードです"}),n.push(l.createElement(l.Fragment,null,l.createElement("span",{style:{color:"red"}},"!!"),l.createElement("span",null," すでに登録済みの資料コードです"))),void b([...E,...n]);if(i([...s,{id:t}]),e&&e.title){n.push(`一つ前の本、「${e.title}」から次の本の候補を探します。`),f(e);const t=await R(e);y(t),t.length>0&&n.push(`候補の本が${t.length}冊みつかりました。`)}}b([...E,...n]),k(!1),setTimeout((()=>k(!0)),100)},F=e=>e.isbn,O=async n=>(f(null),y([]),new Promise((async(s,l)=>{const a=new t({isbn:n,region:"recipe"},(async t=>{if(t.count>=1){a.kill();const n=t.books[0],l={id:n.id,title:n.title,author:n.author,publisher:n.publisher,pubdate:n.pubdate,isbn:n.isbn,tags:[]};l.bibHash=F(l);let r=o.parse(e(l.isbn));l.isbn=r.asIsbn13();const i=await j([l.isbn]);null!==i[0]?s(i[0]):s(l)}else!1===t.running&&0===t.count&&l()}))}))),R=async n=>{const s=n.author.split(",")[0],l=n.publisher,a=n.pubdate;return new Promise((async(r,i)=>{let c=new t({author:s,publisher:l,year_start:a,region:"recipe"},(async t=>{if(!c.killed&&(t.count>5&&c.kill(),console.log(t),t.count>=1)){const s=[];t.books.forEach((t=>{if(null===t.isbn)return;let n=0;t.pubdate&&(n="string"!=typeof t.pubdate?t.pubdate:Number(t.pubdate.split("/")[0].split(".")[0]));let l=o.parse(e(t.isbn)),a=null;try{a=l.asIsbn13()}catch{}a&&s.push({title:t.title+" "+t.volume,author:t.author.split(",")[0],publisher:t.publisher,isbn:a,pubdate:n})})),s.sort((function(e,t){return e.isbn<t.isbn?-1:e.isbn>t.isbn?1:0}));let l=[];const a=[];let i=!1;s.forEach((e=>{e.isbn!==n.isbn&&(i?l.push(e):a.push(e)),e.isbn===n.isbn&&(i=!0)})),l=l.concat(a);const c=[];l.forEach((e=>{c.push(e.isbn)}));const m=await j(c);r(m)}}))}))},j=async e=>new Promise((async(t,n)=>{const s=await fetch("https://api.openBD.jp/v1/get?isbn="+e.join(",")).then((e=>e.json())),l=[];s.forEach((e=>{if(e){const t=[];try{e.onix.DescriptiveDetail.Collection.TitleDetail.TitleElement.forEach(((e,n)=>{t.includes(e.TitleText.content)||t.push(e.TitleText.content)}))}catch{}let n=e.summary.volume;try{""===n&&(n=e.onix.DescriptiveDetail.TitleDetail.TitleElement.PartNumber)}catch{}const s={title:[e.summary.title,n].join(" "),author:e.summary.author,publisher:e.summary.publisher,isbn:e.summary.isbn,pubdate:e.summary.pubdate,cover:e.summary.cover,tags:t};s.bibHash=F(s),l.push(s)}})),t(l)}));return l.createElement("div",{id:"debug"},l.createElement(c,{isOpen:N.show,onClose:()=>S({show:!1,message:""}),hasBackdrop:!1},l.createElement("div",{className:"bp3-card bp3-elevation-4 bp3-overlay-content"},l.createElement(m,{icon:"tick",size:25,color:"#000000"}),N.message)),l.createElement("header",null,l.createElement("h1",null,"カーリルtoolbox: keichan","management"===x?l.createElement("span",{className:"mode"},"資料コード"):null)),l.createElement("main",null,l.createElement("div",{className:"main"},0===s.length?l.createElement("div",{className:"description"},l.createElement("div",null,l.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"},l.createElement("path",{d:"M0 448V64h18v384H0zm26.857-.273V64H36v383.727h-9.143zm27.143 0V64h8.857v383.727H54zm44.857 0V64h8.857v383.727h-8.857zm36 0V64h17.714v383.727h-17.714zm44.857 0V64h8.857v383.727h-8.857zm18 0V64h8.857v383.727h-8.857zm18 0V64h8.857v383.727h-8.857zm35.715 0V64h18v383.727h-18zm44.857 0V64h18v383.727h-18zm35.999 0V64h18.001v383.727h-18.001zm36.001 0V64h18.001v383.727h-18.001zm26.857 0V64h18v383.727h-18zm45.143 0V64h26.857v383.727h-26.857zm35.714 0V64h9.143v383.727H476zm18 .273V64h18v384h-18z"})),"バーコードをスキャンしてください")):null,s.length>=1&&s[s.length-1].title?l.createElement("div",{className:"description"},l.createElement("div",null,l.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"},l.createElement("path",{d:"M0 448V64h18v384H0zm26.857-.273V64H36v383.727h-9.143zm27.143 0V64h8.857v383.727H54zm44.857 0V64h8.857v383.727h-8.857zm36 0V64h17.714v383.727h-17.714zm44.857 0V64h8.857v383.727h-8.857zm18 0V64h8.857v383.727h-8.857zm18 0V64h8.857v383.727h-8.857zm35.715 0V64h18v383.727h-18zm44.857 0V64h18v383.727h-18zm35.999 0V64h18.001v383.727h-18.001zm36.001 0V64h18.001v383.727h-18.001zm26.857 0V64h18v383.727h-18zm45.143 0V64h26.857v383.727h-26.857zm35.714 0V64h9.143v383.727H476zm18 .273V64h18v384h-18z"})),"資料コードをスキャンしてください")):null,s.slice().reverse().map(((e,t)=>l.createElement(l.Fragment,null,"management"===x?l.createElement(a,{key:"managementCode",className:"card active",interactive:!0,elevation:r.TWO},l.createElement("img",{src:`https://img.shields.io/badge/%E8%B3%87%E6%96%99%E3%82%B3%E3%83%BC%E3%83%89-${e.id}-blue`,alt:""})):null,e.title?l.createElement(a,{key:e.bibHash,className:"card indent",interactive:!0,elevation:r.TWO},l.createElement("div",null,e.cover?l.createElement("img",{className:"thumbnail",src:e.cover,alt:""}):null,l.createElement("div",null,l.createElement("img",{src:`https://img.shields.io/badge/book-${e.isbn}-brightgreen`,alt:""}),l.createElement("h3",null,e.title)))):l.createElement(l.Fragment,null,l.createElement("div",{className:"description"},l.createElement("div",null,l.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"},l.createElement("path",{d:"M0 448V64h18v384H0zm26.857-.273V64H36v383.727h-9.143zm27.143 0V64h8.857v383.727H54zm44.857 0V64h8.857v383.727h-8.857zm36 0V64h17.714v383.727h-17.714zm44.857 0V64h8.857v383.727h-8.857zm18 0V64h8.857v383.727h-8.857zm18 0V64h8.857v383.727h-8.857zm35.715 0V64h18v383.727h-18zm44.857 0V64h18v383.727h-18zm35.999 0V64h18.001v383.727h-18.001zm36.001 0V64h18.001v383.727h-18.001zm26.857 0V64h18v383.727h-18zm45.143 0V64h26.857v383.727h-26.857zm35.714 0V64h9.143v383.727H476zm18 .273V64h18v384h-18z"})),"紐つけるバーコードをスキャンしてください")),g&&z.length>0?l.createElement("div",{className:"nextBook"},l.createElement("h2",null,"もしかして",l.createElement("span",null,"(",g.title,"より推定)")),l.createElement("div",{className:"cards"},z.slice(0,5).map((e=>l.createElement(u,{book:e,key:e.isbn}))))):null))))),l.createElement("div",{className:"debug"},l.createElement("div",{className:"logs",ref:H},E.map(((e,t)=>l.createElement("div",{key:"log"+t},e)))),l.createElement("div",{className:"cmd"},"> ",l.createElement("span",{ref:C},"_")))))};h.render(l.createElement(d,null),document.getElementById("app"));
